<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Martinsville CDL / ELDT Training Module</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" type="image/png" href="assets/background.png" />
  </head>

  <body class="min-h-screen bg-gray-50 p-4">
    <div class="card max-w-3xl mx-auto text-center">
      <div class="flex items-center justify-between mb-4">
        <h1 id="moduleTitle" class="text-xl font-bold">
          Training Module
        </h1>
        <!-- ✅ Back to dashboard -->
        <a
          href="dashboard.html"
          class="text-sm underline text-gray-700 hover:text-blue-600"
          >Back to Dashboard</a
        >
      </div>

      <!-- ✅ YouTube Player Container -->
      <div class="relative w-full" style="padding-top: 56.25%;">
        <div id="player" class="absolute top-0 left-0 w-full h-full rounded-lg"></div>
      </div>

      <!-- ✅ Hidden Mark Complete Button -->
      <button
        id="completeBtn"
        onclick="completeModule()"
        class="btn mt-4 bg-blue-600 text-white px-4 py-2 rounded"
        style="display: none;"
      >
        Mark Complete
      </button>
    </div>

    <!-- ✅ Load YouTube API FIRST -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- ✅ Core logic -->
    <script>
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");

      const videoLinks = {
        1: "-deVMu0kyik",
        2: "qZkkgkMLsvI",
        3: "5C_0X6G4ytI"
      };

      const titles = {
        1: "Vehicle Inspection",
        2: "Basic Control Skills",
        3: "On-Road Driving"
      };

      document.getElementById("moduleTitle").innerText =
        titles[id] || "Training Module";

      const completeBtn = document.getElementById("completeBtn");
      if (completeBtn) completeBtn.style.display = "none";

      const scriptURL =
        "https://script.google.com/macros/s/AKfycbzTygqxIMidgXjitFwwtn6QPxT1Vm8MJ_8zJ182oGvDBxC0_MipCOlCp4jalVmFILm9nA/exec";

      let player;
      let maxWatched = 0; // Track how far they’ve actually watched

      // ✅ Create YouTube player
      function onYouTubeIframeAPIReady() {
        const videoId = videoLinks[id] || videoLinks[1];
        player = new YT.Player("player", {
          height: "360",
          width: "640",
          videoId: videoId,
          playerVars: { controls: 1, disablekb: 0 },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange
          }
        });
      }

      // ✅ Start tracking time when ready
      function onPlayerReady() {
        setInterval(() => {
          if (player && player.getCurrentTime) {
            const current = player.getCurrentTime();
            if (current > maxWatched + 1) {
              // Prevent skipping ahead
              player.seekTo(maxWatched, true);
            } else if (current > maxWatched) {
              maxWatched = current;
            }
          }
        }, 1000);
      }

      // ✅ Detect when finished
      function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.ENDED) {
          completeBtn.style.display = "inline-block";
          alert("✅ Video complete! You can now mark this module as finished.");
        }
      }

      // ✅ Log to Google Sheets
      function completeModule() {
        const studentId = localStorage.getItem("studentId") || "Unknown";
        const moduleName = titles[id] || "Unknown Module";
        const payload = {
          studentId,
          module: moduleName,
          status: "Completed",
          score: ""
        };

        fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          mode: "no-cors"
        })
          .then(() => {
            alert("✅ Module logged to training record!");
            window.location.href = "dashboard.html";
          })
          .catch((err) => {
            console.error("Logging failed:", err);
            alert("⚠️ Something went wrong while logging progress.");
          });
      }

      window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
      window.completeModule = completeModule;
    </script>
  </body>
</html>
